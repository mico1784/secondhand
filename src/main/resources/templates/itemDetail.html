<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>상품 상세 정보</title>
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/itemDetail.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="icon" type="image/jpg" href="/images/logo.jpg" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/js/nav.js" defer></script>
    <script src="/js/content.js" defer></script>
</head>

<body data-logged-in="${principal != null}">
<div class="fix">
    <div th:replace="~{nav.html::navbar}"></div>
</div>
<!-- item Detail 상세페이지  -->

<div class="main-container-e">
    <!-- 상품페이지 -->
    <div class="item-detail-container">
        <!-- 상세페이지 목록버튼 -->
        <a class="list-back-btn" href="/list"><span>&#10094;</span> 목록으로 돌아가기</a>
        <div class="detail-content">
            <div class="detail-img">
                <!--    판매완료 추가     -->
                <div class="de-soldout-text" id="soldoutText" style="display: none;">
                    <strong>판매완료</strong>
                </div>
                <div class="heart">
                    <i id="heart-icon" class="fa-solid fa-heart"
                       th:classappend="${isWished ? 'active' : ''}"
                       style="position: absolute; right: 3%; top: 3%; font-size: 30px; color: ${isWished ? 'red' : 'white'};"></i>
                </div>
                <img id="" th:src="${item.imgURL}" alt="상품 이미지">
            </div>
            <div class="d-text-content">
                <div class="item-category">
                    <p>카테고리: <span th:text="${item.category}">핸드폰</span></p> <!-- 카테고리 추가 -->
                    <p><span>&#10095;</span></p>
                    <p>서브 카테고리: <span th:text="${item.subcategory}"></span></p> <!-- 서브 카테고리 추가 -->
                </div>
                <div class="detail-text-box">
                    <!-- 예약중-판매완료 추가 -->
                    <div class="detail-situation" style="display: block">
                        <span id="currentSituation" th:text="${item.situation}">SoldOut</span>
                    </div>
                    <h3 class="de-item-title" th:text="${item?.title}">상품명</h3>
                    <div class="de-select-flex">
                        <h4 class="de-item-price" th:text="${item.formattedPrice+'원'}">450,000원</h4>
                        <!-- 상황 선택 부분 (상태 변경은 판매자가 할 수 있음) -->
                        <label style="display: none;" for="situation"></label>
                        <select class="detail-select" id="situation" name="situation" required
                                th:style="${item.seller.username == currentUsername ? 'display:block;' : 'display:none;'}">
                            <option value="판매중" th:selected="${item.situation == '판매중'}">판매중</option>
                            <option value="예약중" th:selected="${item.situation == '예약중'}">예약중</option>
                            <option value="판매완료" th:selected="${item.situation == '판매완료'}">판매완료</option>
                        </select>

                        <!-- 현재 상태 표시 -->
                        <!--                        <div th:style="${item.seller.username != currentUsername ? 'display:block;' : 'display:none;'}">
                                                    <span id="currentSituation" th:text="${item.situation}"></span>
                                                </div>-->
                    </div>
                    <!-- 등록일 표시 부분 -->
                    <div class="item-desc-box">
                        <div class="item-upload-date">
                            등록일: <span th:text="${formattedDate}"></span>
                        </div>
                        <!-- 거래지역 추가 -->
                        <div>
                            <span class="de-location">거래지역: </span>
                            <a th:href="@{'https://map.kakao.com/link/search/' + ${item.location}}" target="_blank">
                                <span th:text="${item.location}"></span>
                            </a>
                        </div>
                    </div>
                    <div class="detail-actions-btn">
                        <!-- 찜하기, 채팅하기 (판매자에게는 보이지 않음) -->
                        <div class="detail-btn-left">
                            <form class="point-form" action="/wishlist/add" id="wishlist-form" method="post" th:if="${item.seller.username != currentUsername}">
                                <input name="itemId" th:value="${item.id}" style="display:none">
                                <input name="itemTitle" th:value="${item.title}" style="display:none">
                                <input name="itemImgURL" th:value="${item.imgURL}" style="display:none">
                                <input name="itemPrice" th:value="${item.price}" style="display:none">
                                <input name="itemUploadedDate" th:value="${item.uploadDate}" style="display:none">
                                <button type="submit" id="wishlist-btn" class="point-btn detail-btn">찜하기</button>
                                <input type="hidden" id="isLoggedIn" th:value="${isLoggedIn}"/>
                            </form>
                            <form th:action="@{/chat/} + ${item.id}" th:if="${item.seller.username != currentUsername}">
                                <button class="chat-btn detail-btn">채팅하기</button>
                            </form>


                        <!-- 리뷰 작성 버튼 -->
                        <form action="#" th:action="@{/item/review/{id}(id=${item.id})}" method="get" th:if="${item.seller.username != currentUsername}">
                            <button type="submit" class="review-btn detail-btn">리뷰 작성</button>
                        </form>

                        <!-- 수정하기, 삭제하기 (판매자만 보임) -->
                        <div class="detail-btn-right">
                            <!-- 수정 버튼 (판매자만 보이게) -->
                            <form th:action="@{/item/edit/{id}(id=${item.id})}" method="get"
                                  th:if="${item.seller.username == currentUsername}">
                                <button type="submit" class="edit-btn detail-btn">수정하기</button>
                            </form>
                            <!-- 삭제 버튼 (판매자만 보이게) -->
                            <form th:action="@{/item/delete}" method="post" th:if="${item.seller.username == currentUsername}">
                                <input type="hidden" name="id" th:value="${item.id}" />
                                <button class="del-btn detail-btn" type="submit">삭제하기</button>
                            </form>
                        </div>
                    </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <!--상품정보 및 회원의 상품 추가-->
        <div class="detail-content-bot">
            <!-- 상품 정보 (상품 등록 제목 및 내용)-->
            <div class="de-text-left">
                <h4 id="">상품 정보</h4>
                <div class="left-text-box" th:utext="${formattedItemDesc}"></div>
            </div>

            <div class="line"></div>
            <div class="de-text-right">
                <!--판매자 정보 추가-->
                <h4 id="">판매 회원 정보</h4>
                <div class="member-box">
                    <div class="member-img">
                        <img th:if="${seller != null and seller.profileImageURL != null}" th:src="${seller.profileImageURL}" class="profile-icon">
                        <img th:if="${seller == null or seller.profileImageURL == null}" src="/images/ppp.jpg" class="profile-icon">
                    </div>

                    <div class="member-text">
                        <span id="" class="user-id" th:text="${item.seller.name}">닉네임</span>
                        <a href="" id="my-item-list" th:text="'상품명: ' + ${item.title}">상품</a>
                    </div>
                </div>

                <!-- 리뷰 박스 -->
                <div class="review-box" th:if="${#lists.size(reviews) > 0}">
                    <div th:each="review, iterStat : ${reviews}">
                        <!--리뷰 보여지는 칸-->
                        <div class="detail-item-review" th:classappend="${iterStat.index >= 3 ? 'hidden-review' : ''}">
                            <div class="rev-profile-content">
                                <div class="review-profile-img">
                                    <img th:if="${review.profileImageURL != null}" th:src="${review.profileImageURL}" class="profile-icon">
                                    <img th:if="${review.profileImageURL == null}" src="/images/ppp.jpg" class="profile-icon">
                                </div>
                                <div class="rev-profile-box">
                                    <span class="d-review-name"><p th:text="${review.reviewerName}">리뷰 작성자 이름</p></span>
                                    <span id="별점">
                        <p>
                            <span th:text="${#strings.repeat('★', review.rating) + #strings.repeat('☆', 5 - review.rating)}"
                                  style="font-size: 20px; color: gold; white-space: nowrap; letter-spacing: 0;
                                         text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);"></span>
                        </p>
                    </span>
                                </div>
                            </div>
                            <!--리뷰 내용-->
                            <div class="review-writer">
                                <p th:text="${review.content}">리뷰 내용</p>
                            </div>
                        </div>
                    </div>

                    <!-- 더 보기 / 접기 버튼 -->
                    <div class="plus" th:if="${#lists.size(reviews) > 3}" onclick="toggleReviews()">
                        <span id="review-toggle-text" style="cursor: pointer;">펼치기 (<span th:text="${#lists.size(reviews) - 3}" ></span>)</span>
                    </div>
                </div>
            </div>
            </div>
        </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const situationSelect = document.getElementById('situation');
        const currentSituationElement = document.getElementById('currentSituation');

        // 페이지 로드 시 현재 상태 설정
        const currentSituation = currentSituationElement.innerText.trim(); // 현재 상태 텍스트 가져오기
        if (currentSituation) {
            situationSelect.value = currentSituation; // 현재 상태에 맞춰 선택
        }

        situationSelect.addEventListener('change', function() {
            const situation = this.value;
            const itemId = [[${item.id}]];

            if (!itemId) {
                alert('아이템 ID가 유효하지 않습니다.'); // 에러 처리
                return;
            }

            fetch(`/item/${itemId}/situation`, {
                method: 'PUT', // PUT 대신 POST를 사용할 수 있음
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ situation: situation })
            })
            .then(response => {
                if (response.ok) {
                    alert('아이템 상태가 성공적으로 업데이트되었습니다.');
                    // 현재 상태 업데이트
                    currentSituationElement.innerText = situation;
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                alert('상태 업데이트 중 오류가 발생했습니다: ' + error);
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
         const situationSelect = document.getElementById('situation');
         const currentSituationElement = document.getElementById('currentSituation');
         const soldoutText = document.getElementById('soldoutText');

         // 초기 로드 시 상태에 따라 '판매완료' 표시 설정
         if (currentSituationElement.innerText.trim() === '판매완료') {
             soldoutText.style.display = 'block';
         }

         // 상태 변경 이벤트 리스너 추가
         situationSelect.addEventListener('change', function() {
             const newSituation = this.value;

             // 변경된 상황이 '판매완료'이면 '판매완료' 텍스트를 표시
             if (newSituation === '판매완료') {
                 soldoutText.style.display = 'block';
                 currentSituationElement.innerText = newSituation; // 현재 상태 업데이트
             } else {
                 soldoutText.style.display = 'none';
                 currentSituationElement.innerText = newSituation; // 현재 상태 업데이트
             }

             // AJAX 요청
             const itemId = [[${item.id}]]; // 타임리프에서 값 주입
             fetch(`/item/${itemId}/situation`, {
                 method: 'PUT',
                 headers: {
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify({ situation: newSituation })
             })
             .then(response => {
                 if (!response.ok) {
                     return response.text().then(text => { throw new Error(text); });
                 }
             })
             .catch(error => {
                 alert('상태 업데이트 중 오류가 발생했습니다: ' + error);
             });
         });
     });
</script>

<script>
    let reviewsExpanded = false; // 현재 리뷰가 펼쳐져 있는지 상태 관리

    function toggleReviews() {
        const reviews = document.querySelectorAll('.detail-item-review');
        const toggleText = document.getElementById('review-toggle-text');
        const hiddenReviews = document.querySelectorAll('.hidden-review'); // 현재 숨겨진 리뷰

        if (reviewsExpanded) {
            // 리뷰 접기 - 첫 3개만 표시하고 나머지는 숨김
            reviews.forEach((review, index) => {
                if (index >= 3) {
                    review.classList.add('hidden-review');
                }
            });
            toggleText.innerHTML = `펼치기 (${reviews.length - 3})`;
        } else {
            // 리뷰 펼치기 - 모든 리뷰 표시
            hiddenReviews.forEach(review => {
                review.classList.remove('hidden-review');
            });
            toggleText.innerHTML = '접기';
        }

        reviewsExpanded = !reviewsExpanded; // 상태 토글
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const wishlistBtn = document.getElementById("wishlist-btn");
        const heartIcon = document.getElementById("heart-icon");
        const isLoggedIn = JSON.parse(document.getElementById("isLoggedIn").value); // 서버에서 렌더링된 로그인 여부

        wishlistBtn.addEventListener("click", function () {
            if (!isLoggedIn) {
                alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
                window.location.href = "/login";
                return;
            }

            const itemId = document.querySelector("input[name='itemId']").value;

            // 로그인 상태일 때 찜하기 요청
            fetch("/wishlist/add", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ itemId: itemId }),
            })
            .then((response) => {
                if (response.ok) {
                    // 성공적으로 찜하기 처리되었을 때만 색깔 변경
                    heartIcon.style.color =
                        heartIcon.style.color === "red" ? "white" : "red";
                    alert("찜하기가 성공적으로 추가/삭제 되었습니다.");
                } else {
                    // 실패 시 오류 메시지 띄우지 않음
                    alert("찜하기 요청이 실패했습니다.");
                }
            })
            .catch((error) => {
                // 오류 발생 시, 콘솔에만 기록하고 메시지 노출하지 않음
                console.error("찜하기 요청 중 오류 발생:", error);
            });
        });
    });
</script>


<!-- 휴대폰 카테고리 섹션 -->
<div th:if="${item.category == '휴대폰'}">
    <section th:replace="~{content.html::phoneItems}"></section>
</div>

<!-- 패드 카테고리 섹션 -->
<div th:if="${item.category == '패드'}">
    <section th:replace="~{content.html::padItems}"></section>
</div>

<!-- 워치 카테고리 섹션 -->
<div th:if="${item.category == '워치'}">
    <section th:replace="~{content.html::watchItems}"></section>
</div>

<div class="ad">
    <img src="/images/엉덩이.png">
</div>
<footer th:replace="~{footer.html::footer}"></footer>
</body>
</html>