<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>상품 상세 정보</title>
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="/css/itemDetail.css">
    <link rel="icon" type="image/jpg" href="/images/logo.jpg" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/js/nav.js" defer></script>
</head>

<body>
<div class="fix">
    <div th:replace="~{nav.html::navbar}"></div>
</div>
<!-- item Detail 상세페이지  -->

<div class="main-container-e">
    <!-- 상품페이지 -->
    <div class="item-detail-container">
        <!-- 상세페이지 목록버튼 -->
        <button class="list-back-btn" href="/item/list">
            <span>&#10094;</span>
            <span>목록으로 돌아가기</span>
        </button>
        <div class="detail-content">
            <div class="detail-img">
                <img id="" th:src="${item.imgURL}" alt="상품 이미지">
            </div>
            <div class="d-text-content">
                <div class="item-category">
                    <p>카테고리: <span th:text="${item.category}">핸드폰</span></p> <!-- 카테고리 추가 -->
                    <p><span>&#10095;</span></p>
                    <p>서브 카테고리: <span th:text="${item.subcategory}"></span></p> <!-- 서브 카테고리 추가 -->
                </div>
                <div class="detail-text-box">
                    <h3 class="de-item-title" th:text="${item?.title}">핸드폰이 자가증식을 해서 몸집이 점점 커지는데 이거 어떻게 하는거지 </h3>
                    <div class="de-select-flex">
                        <h4 class="de-item-price" th:text="${item.price + '원'}">450,000원</h4>

                        <!-- 예약중-판매완료 추가 -->
                        <!-- 상황 선택 부분 (상태 변경은 판매자가 할 수 있음) -->
                        <label style="display: none;" for="situation"></label>
                        <select class="detail-select" id="situation" name="situation" required
                                th:style="${item.seller.username == currentUsername ? 'display:block;' : 'display:none;'}">
                            <option value="판매중" th:selected="${item.situation == '판매중'}">판매중</option>
                            <option value="예약중" th:selected="${item.situation == '예약중'}">예약중</option>
                            <option value="판매완료" th:selected="${item.situation == '판매완료'}">판매완료</option>
                        </select>

                        <!-- 현재 상태 표시 -->
                        <div th:style="${item.seller.username != currentUsername ? 'display:block;' : 'display:none;'}">
                            <span id="currentSituation" th:text="${item.situation}"></span>
                        </div>

                        <!-- 등록일 표시 부분 -->
                        <div class="item-desc-box">
                            <div class="item-upload-date">
                                등록일: <span th:text="${formattedDate}"></span>
                            </div>
                            <span id="" class="de-location">거래지역:</span>
                        </div>
                    </div>
                </div>
                <!-- 거래 지역 추가-->

                <div class="detail-actions-btn">
                    <!--찜하기, 채팅하기-->
                    <div class="detail-btn-left">
                        <form class="point-form" action="/wishlist/add" method="post">
                            <input name="itemId" th:value="${item.id}" style="display:none">
                            <input name="itemTitle" th:value="${item.title}" style="display:none">
                            <input name="itemImgURL" th:value="${item.imgURL}" style="display:none">
                            <input name="itemPrice" th:value="${item.price}" style="display:none">
                            <input name="itemUploadedDate" th:value="${item.uploadDate}" style="display:none">
                            <button class="point-btn detail-btn" type="submit">찜하기</button>
                        </form>
                        <button class="chat-btn detail-btn">채팅하기</button>

                        <!-- 리뷰 작성 버튼 추가 -->
                        <form action="#" th:action="@{/item/review/{id}(id=${item.id})}" method="get">
                            <button type="submit" class="review-btn detail-btn">리뷰 작성</button>
                        </form>

                    <!--수정 삭제 버튼-->
                    <div class="detail-btn-right">
                        <!-- 수정 버튼 (판매자만 보이게) -->
                        <form th:action="@{/item/edit/{id}(id=${item.id})}" method="get"
                              th:if="${item.seller.username == currentUsername}">
                            <button type="submit" class="edit-btn detail-btn">수정하기</button>
                        </form>
                        <!-- 삭제 버튼 (판매자만 보이게) -->
                        <form th:action="@{/item/delete}" method="post" th:if="${item.seller.username == currentUsername}">
                            <input type="hidden" name="id" th:value="${item.id}" />
                            <button class="del-btn detail-btn" type="submit">삭제하기</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!--상품정보 및 회원의 상품 추가-->
        <div class="detail-content-bot">
            <!-- 상품 정보 (상품 등록 제목 및 내용)-->
            <div class="de-text-left">
                <h4 id="">상품 정보</h4>
                <div class="detail-text-box" id="" th:text="${item.itemDesc}">
                    Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Nisl tincidunt eget nullam non. Quis hendrerit dolor magna eget est lorem ipsum dolor sit
                </div>
            </div>
            <div class="line"></div>
            <!--판매자 정보 추가-->
            <div class="de-text-right">
                <h4 id="">판매 회원 정보</h4>
                <div class="member-box">
                    <div id="" class="member-img">
                        <img th:src="${item.imgURL}" alt="이미지">
                    </div>
                    <div class="member-text">
                        <span id="" class="user-id" th:text="'아이디: ' + ${item.seller.username}">아이디:주절주절</span>
                        <a href="" id="my-item-list" th:text="'상품: ' + ${item.title}">상품</a>
                        <span>|</span>
                        <span id="" class="follow-right">팔로워</span>
                    </div>
                </div>
                <button class="follow-btn" id="">
                    팔로우 +
                </button>

                <div class="de-item-box">
                    <!-- 가격, 이미지 묶음 -->
                    <div id="" class="detail-item-list">
                        <div class="detail-item-img">
                            <img id="" th:src="${item.imgURL}" alt="상품이미지">
                        </div>
                        <span id="">가격</span>
                    </div>
                </div>
                <button class="d-add-item-btn">상품 더보기</button>
                <!-- 구매자 상품 리뷰 추가 -->
                <div class="review-box">
                    <!--리뷰 보여지는 칸-->
                    <div class="detail-item-review">
                        <div class="rev-profile-content">
                            <div class="review-profile-img">
                                <img th:src="${item.imgURL}" alt="">
                            </div>
                            <div class="rev-profile-box">
                  <span id="해당 상품 제목" class="d-review-name">
                    닉네임
                  </span>
                                <span id="별점">
                    ★★★★☆
                  </span>
                            </div>
                        </div>
                        <div id="" class="review-writer">
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et
                                dolore magna aliqua. Nisl tincidunt eget nullam non. Quis hendrerit dolor magna eget est lorem ipsum
                                dolor sit
                            </p>
                        </div>
                    </div>
                </div>
                <button class="d-add-review-btn" id="">리뷰 더보기</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const situationSelect = document.getElementById('situation');
        const currentSituationElement = document.getElementById('currentSituation');

        // 페이지 로드 시 현재 상태 설정
        const currentSituation = currentSituationElement.innerText.trim(); // 현재 상태 텍스트 가져오기
        if (currentSituation) {
            situationSelect.value = currentSituation; // 현재 상태에 맞춰 선택
        }

        situationSelect.addEventListener('change', function() {
            const situation = this.value;
            const itemId = [[${item.id}]];

            if (!itemId) {
                alert('아이템 ID가 유효하지 않습니다.'); // 에러 처리
                return;
            }

            fetch(`/item/${itemId}/situation`, {
                method: 'PUT', // PUT 대신 POST를 사용할 수 있음
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ situation: situation })
            })
            .then(response => {
                if (response.ok) {
                    alert('아이템 상태가 성공적으로 업데이트되었습니다.');
                    // 현재 상태 업데이트
                    currentSituationElement.innerText = situation;
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            })
            .catch(error => {
                alert('상태 업데이트 중 오류가 발생했습니다: ' + error);
            });
        });
    });
</script>
</body>
</html>